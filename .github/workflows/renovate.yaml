---
name: Renovate

on:
  push:
    branches: [main]
    paths:
      - '*.json'
      - '.github/renovate.json'
      - '.github/workflows/renovate.yaml'
  schedule:
    - cron: '0/15 * * * *'
  workflow_call:
    inputs:
      autodiscover:
        description: Autodiscover all repositories.
        required: false
        type: boolean
        default: true
      dry_run:
        description: Perform a dry run by logging messages instead of creating/updating/deleting branches and PRs.
        required: false
        type: boolean
        default: true
      log_level:
        description: Set the log level.
        required: false
        type: string
        default: 'info'
      print_config:
        description: Log the fully-resolved Renovate config for each repository, plus fully-resolved presets.
        required: false
        type: boolean
        default: false
    secrets:
      APPLICATION_ID:
        description: GitHub App ID
        required: true
      APPLICATION_PRIVATE_KEY:
        description: GitHub App private key
        required: true
  workflow_dispatch:
    inputs:
      autodiscover:
        description: Autodiscover all repositories.
        required: false
        type: boolean
        default: true
      dry_run:
        description: Perform a dry run by logging messages instead of creating/updating/deleting branches and PRs.
        required: false
        type: boolean
        default: true
      log_level:
        description: Set the log level.
        required: false
        type: choice
        default: 'info'
        options: ['trace', 'debug', 'info', 'warn', 'error', 'fatal']
      print_config:
        description: Log the fully-resolved Renovate config for each repository, plus fully-resolved presets.
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-$${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions: {}

env:
  # Use the contains function to convert the boolean input to a string and compare it to 'false'. This is required when
  # the workflow is triggered from workflow_call because the github context is that of the workflow that called this
  # workflow.
  AUTODISCOVER: ${{ inputs.autodiscover || contains(inputs.autodiscover, 'false') && 'false' || 'true' }}
  DRY_RUN: ${{ inputs.dry_run || contains(inputs.dry_run, 'false') && 'false' }}
  FORCE_COLOR: 3

jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - name: Get Workflow Token
        id: get_workflow_token
        uses: peter-murray/workflow-application-token-action@8e1ba3bf1619726336414f1014e37f17fbadf1db # v2.1.0
        with:
          application_id: ${{ secrets.APPLICATION_ID }}
          application_private_key: ${{ secrets.APPLICATION_PRIVATE_KEY }}
          organization: ${{ github.repository_owner }}
          permissions: >
            checks:write,
            contents:write,
            issues:write,
            pull_requests:write,
            vulnerability_alerts:read,
            workflows:write

      - name: Renovate
        uses: renovatebot/github-action@57ea3203719eee5f6de53b57eb613562b34e72ae # v34.146.1
        with:
          token: 'x-access-token:${{ steps.get_workflow_token.outputs.token }}'
        env:
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
          RENOVATE_AUTODISCOVER: ${{ env.AUTODISCOVER }}
          RENOVATE_DRY_RUN: ${{ fromJSON(env.DRY_RUN) && 'full' || '' }}
          RENOVATE_GIT_AUTHOR: 'bfra-me[bot] <118100583+bfra-me[bot]@users.noreply.github.com>'
          RENOVATE_GIT_IGNORED_AUTHORS: '["bot@renovateapp.com","29139614+renovate[bot]@users.noreply.github.com","support@github.com","261136+bfra-me@users.noreply.github.com"]'
          RENOVATE_PLATFORM: github
          RENOVATE_PRINT_CONFIG: ${{ inputs.print_config || 'false' }}
          RENOVATE_REPOSITORIES: ${{ !fromJSON(env.AUTODISCOVER) && format('["{0}"]', github.repository) || '' }}
          RENOVATE_USERNAME: 'bfra-me[bot]'
